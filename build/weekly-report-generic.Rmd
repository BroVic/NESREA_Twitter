---
title: "Weekly Social Media Report"
author: "NESREA Web Monitoring Group"
output:
  word_document: default
  html_document: default
---

<!--
******************************************************************************
*                         GENERAL NOTICE                                     *
* This is a generic reporting format for the NESREA Web Monitoring Group.    *
* To easily use it click on 'Knit' in the toolbar above (applies to RStudio).*
******************************************************************************
                                                                           -->
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r startup, message=FALSE, include=FALSE}
## The existence of required dependencies is checked for. If absent, these are
## automatically downloaded and installed. Then packages are (quietly) loaded.
pkglist <- c("DBI",
             "RSQLite",
             "Rfacebook",
             "dplyr",
             "ggplot2",
             "lubridate",
             "qdap",
             "rvest",
             "SnowballC",
             "stringr",
             "tm",
             "twitteR",
             "wordcloud")
not_installed <- pkglist[!pkglist %in% (.packages(all.available = TRUE))]
if (length(not_installed))
  install.packages(not_installed)
suppressPackageStartupMessages(lapply(pkglist, library, character.only = TRUE))

source("global-function-prototypes.R")
source_but_also_check_for(c("../twitter/tw-functions.R",
                            "../facebook/fb-functions.R"))

rm(source_but_also_check_for, pkglist, not_installed)
```

# 1.0 Introduction
This is the NESREA Social Media Monitoring Report.  

**Date of Report**: `r format(today(), "%A, %d %B %Y")`  
**Period of Reporting**: `r format(today() - 7, "%A, %d %B %Y")`

```{r load data, message=FALSE}
                      ##############
                      #  TWITTER   #
                      ##############
## Access stored tweets
register_sqlite_backend("../data/nesreanigeria.db") 
all_data <- load_tweets_db(as.data.frame = TRUE, "nesreanigeria_tweets")


## Add a column of Date objects for easy categorisation. Also carry out a 
## check to see whether the database needs to be updated.
all_data$date_only <- as.Date(all_data$created)

wk_data <- filter(all_data,
                  date_only >= (today() - 7) & date_only <= (today() - 1))
last_wk <- filter(all_data,
                  date_only >= (today() - 14) & date_only <= (today() - 8))

## Remove characters from the text of tweets that are not human-readable, as 
## they would be of no practical use in the analysis.
wk_data$text <- str_replace_all(wk_data$text, "[^[:graph:]]", " ")

# Some objects to be used to generate and/or display statistics
no.wk <- nrow(wk_data)
month_begin <- floor_date(today(), "month")
month_end <- ceiling_date(today(), "month")
mth_data <- filter(all_data, date_only >= month_begin & date_only <= month_end)
mostRTed <- wk_data$text[which.max(wk_data$retweetCount)]
mostFaved <- wk_data$text[which.max(wk_data$favoriteCount)]
tweets_by_us <- filter(wk_data, screenName == "NESREANigeria")
busiest_day <- which.max(table(wk_data$date_only))
busiest_day <- ymd(names(busiest_day))
```

# 2.0 Summary Statistics
## 2.1 Twitter
|       Description                        |      Result                    |
|------------------------------------------|--------------------------------|
|No. of followers (overall)                |                                |
|No. of new followers (in last 7 days)     |                                |
|No. of tweets in `r format(today(), "%B")`|`r nrow(mth_data)`              |
|No. of tweets in last 7 days              |`r no.wk`                       |
|Total tweets **by** NESREA                |`r nrow(tweets_by_us)`          |
|Total tweets **on** NESREA                |`r nrow(wk_data)`               |
|Average number of tweets per day          |`r floor(nrow(wk_data)/7)`      |
|Day of highest activity                   |`r format(busiest_day, "%d %B")`|
|Top 5 influential handles                 |`r print("---")`                |
|Most liked tweet                          |`r mostFaved`                   |
|Most retweeted tweet                      |`r mostRTed`                    |
|Comparative tweet volume (week-on-week)   |**`r no.wk - nrow(last_wk)`**   |
|                                          |                                |

```{r load-fb-data, message=FALSE}
                        ############
                        # Facebook #
                        ############
## Load data on Facebook Page posts from database;
## also do a little data wrangling
connxn <- dbConnect(SQLite(), "../data/nesreanigeria.db")

fbPosts <- dbGetQuery(connxn, 'SELECT * FROM nesreanigeria_fbposts') %>%
  prepare_data(.) %>%
  select(message:shares_count) %>%
  mutate(created_mth = format(as.Date(created_time), "%B")) %>%
  mutate(created_yr = format(as.Date(created_time), "%Y"))


fbComments <- dbReadTable(connxn, "nesreanigeria_fbcomments")
fbLikes <- dbReadTable(connxn, "nesreanigeria_fblikes")

dbDisconnect(connxn)
rm(connxn)

## Convert to date-time structures
fbPosts$created_time <- as.POSIXct(fbPosts$created_time)
fbComments$created_time <- as.POSIXct(fbComments$created_time)

## make variable for monthly data
thisMth <- format(today(), "%B")
thisYr <- format(today(), "%Y")

fbPosts$created_mth <-
  fbPosts$created_mth %>%
  factor(levels = month.name, ordered = TRUE)

mth_Posts <- fbPosts %>%
  filter(created_mth == thisMth & created_yr == thisYr)
wk_Posts <- mth_Posts %>%
  filter(created_time >= (today() - 7))
```

## 2.2 Facebook
|     Description            |    Result                                |
|----------------------------|------------------------------------------|
|NESREA Page Posts (All-time)|`r nrow(fbPosts)`                         |
|Posts in `r thisMth`        |`r nrow(mth_Posts)`                       |
|Posts in the past 7 days    |`r nrow(wk_Posts)`                        |
|Most Liked  (Overall)       |`r return_text(fbPosts, "likes_count")`   |
|Most Liked in `r thisMth`   |`r return_text(mth_Posts, "likes_count")` |
|Most Shared (Overall)       |`r return_text(fbPosts, "shares_count")`  |
|Most Shared in `r thisMth`  |`r return_text(mth_Posts, "shares_count")`|
|Most Commented  (Overall)   |`r return_text(fbPosts, "comments_count")`|
|                            |                                          |

# 3.0 Exploratory Analysis
## 3.1 Twitter
```{r plain density, warning=FALSE, message=FALSE}
simplePlot <- plain_dens_plot(data = wk_data, platform = "twitter")
simplePlot
```


```{r disaggregated tweets density}
distr <- ggplot(wk_data, aes(created)) +
  geom_density(aes(fill = isRetweet), alpha = .5) +
  theme(legend.justification = c(1, 1), legend.position = c(1, 1)) +
  xlab("Date") +
  ggtitle(paste("Distribution of tweets for", format(min(wk_data$created), "%d %b"), "to", format(max(wk_data$created), "%d %b %Y")))

distr
```


```{r daily tweets plot}  
dlyPlots <- simplePlot +
  facet_wrap( ~ date_only)
dlyPlots
```


```{r twitter sentiments-1}
spl <- split(wk_data, wk_data$isRetweet)
origTwts <- spl[['FALSE']]

twPol <- compute_emotional_valence(origTwts$text)
visualise_pol_diff(pol.list = twPol)
```

* __Most positive tweet__: `r origTwts$text[which.max(origTwts$emotionalValence)]`
* __Most negative tweet__: `r origTwts$text[which.min(origTwts$emotionalValence)]`  

```{r twitter sentiments-2}
origTwts$emotionalValence <- sapply(twPol, function(x) x$all$polarity)
generate_wordcloud(origTwts, twPol, site = "Twitter")
```


```{r network}
RT <- mutate(spl[['TRUE']], sender = substr(text, 5, regexpr(':', text) - 1))
```


## 3.2 Facebook
**Disclaimer**: *This section is still being developed and should be considered as experimental* 

```{r density dist: FB posts}
ggplot(fbPosts, aes(created_time)) +
  geom_density(fill = "purple") +
  ggtitle("Distribution of Facebook posts")
```


```{r facebook density plot}
plain_dens_plot(fbComments, platform = "facebook")
```


```{r fb polarities}
fbPol <- compute_emotional_valence(text.var = fbComments$message)
visualise_pol_diff(pol.list = fbPol)
```


```{r facebook wordcloud}
fbComments$emotionalValence <- sapply(fbPol, function(x) x$all$polarity)
generate_wordcloud(fbComments, fbPol, site = "Facebook")
```

<!-- ## 3.3 Website 
```{r}

```
-->

# 4.0 Observations
## 4.1 General

## 4.2 Twitter

## 4.3 Facebook

<!-- ## 4.4 Website -->

# 5.0 Recommendations

```{r signatories, echo=FALSE}
victor <- person("Victor", "Ordu", email =  "victor.ordu@nesrea.gov.ng", comment = "Chairman Web Monitoring Group")
remi <- person("Remi", "Agunbiade", email = "remi.agunbiade@nesrea.gov.ng", comment = "Member, Web Monitoring Group")
amaka <- person("Amaka", "Ejiofor", email = "amaka.ejiofor@nesrea.gov.ng", comment = "Member, Web Monitoring Group")
eze <- person("Ezechinyere", "Achilefu", email = "ezechinyere.achilefu@nesrea.gov.ng", comment = "Member, Web Monitoring Group")
```

Submitted by:

`r paste(victor$given, victor$family)`  
`r victor$comment`  

***  
Built with *R `r getRversion()`*.