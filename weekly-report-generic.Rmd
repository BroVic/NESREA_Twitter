---
title: "Weekly Social Media Report"
author: "NESREA Web Monitoring Group"
params:
  client: NESREA
output:
  html_document: default
  word_document: default
---

<!--
******************************************************************************
*                         GENERAL NOTICE                                     *
* This is a generic reporting format for the NESREA Web Monitoring Group.    *
* To easily use it click on 'Knit' in the toolbar above (applies to RStudio).*
******************************************************************************
                                                                           -->
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r startup, message=FALSE, include=FALSE}
## The existence of required dependencies is checked for. If absent, these are
## automatically downloaded and installed. Then packages are (quietly) loaded.
pkglist <- c("DBI",
             "RSQLite",
             "Rfacebook",
             "dplyr",
             "ggplot2",
             "lubridate",
             "qdap",
             "SnowballC",
             "stringr",
             "tm",
             "twitteR",
             "wordcloud")

not_installed <- pkglist[!pkglist %in% (.packages(all.available = TRUE))]

if (length(not_installed))
  install.packages(not_installed)

suppressPackageStartupMessages(lapply(pkglist, library, character.only = TRUE))

## We want to not only source certain project files, but also ensure that
## such files exist. Once done, clean up is done
source_but_also_check_for <- function(ff) {
  sapply(ff, function(x) {
    if (file.exists(x)) {
      source(x)
      } else {
        warning(paste(sQuote(x), "was not found in the working directory"))
      }
  })
}

source_but_also_check_for(c("twitter/tw-functions.R",
                            "facebook/fb-functions.R"))
rm(source_but_also_check_for, pkglist, not_installed)
```

# 1.0 Introduction
This is the `r params$client` Social Media Monitoring Report.  

**Date of Report**: `r format(today(), "%A, %d %B %Y")`  
**Period of Reporting**: `r format(today() - 7, "%A, %d %B %Y")`

```{r load data, message=FALSE}
                      ##############
                      #  TWITTER   #
                      ##############
## Access stored tweets
register_sqlite_backend("data/nesreanigeria.db") 
all_data <- load_tweets_db(as.data.frame = TRUE, "nesreanigeria_tweets")


## Add a column of Date objects for easy categorisation. Also carry out a 
## check to see whether the database needs to be updated.
all_data$date_only <- as.Date(all_data$created)

if (all_data$date_only[nrow(all_data)] < today()) {
  warning("The database may be outdated.\nRun 'logon_to_twitter() followed by 'update_nesrea_db()' to update it before knitting the document.")
}

wk_data <- filter(all_data,
                  date_only >= (today() - 7) & date_only <= (today() - 1))
last_wk <- filter(all_data,
                  date_only >= (today() - 14) & date_only <= (today() - 8))

## Remove characters from the text of tweets that are not human-readable, as 
## they would be of no practical use in the analysis.
wk_data$text <- str_replace_all(wk_data$text, "[^[:graph:]]", " ")

# Some objects to be used to generate and/or display statistics
no.wk <- nrow(wk_data)
month_begin <- floor_date(today(), "month")
month_end <- ceiling_date(today(), "month")
mth_data <- filter(all_data, date_only >= month_begin & date_only <= month_end)
mostRTed <- wk_data$text[which.max(wk_data$retweetCount)]
mostFaved <- wk_data$text[which.max(wk_data$favoriteCount)]
tweets_by_us <- filter(wk_data, screenName == "NESREANigeria")
busiest_day <- which.max(table(wk_data$date_only))
busiest_day <- ymd(names(busiest_day))
```

# 2.0 Summary Statistics
## 2.1 Twitter
|       Description                        |      Result                    |
|------------------------------------------|--------------------------------|
|No. of followers (overall)                |                                |
|No. of new followers (in last 7 days)     |                                |
|No. of tweets in `r format(today(), "%B")`|`r nrow(mth_data)`              |
|No. of tweets in last 7 days              |`r no.wk`                       |
|Total tweets **by** `r params$client`     |`r nrow(tweets_by_us)`          |
|Total tweets **on** `r params$client`     |`r nrow(wk_data)`               |
|Average number of tweets per day          |`r floor(nrow(wk_data)/7)`      |
|Day of highest activity                   |`r format(busiest_day, "%d %B")`|
|Top 5 influential handles                 |`r print("---")`                |
|Most liked tweet                          |`r mostFaved`                   |
|Most retweeted tweet                      |`r mostRTed`                    |
|Comparative tweet volume (week-on-week)   |**`r no.wk - nrow(last_wk)`**   |
|                                          |                                |

```{r load-fb-data, message=FALSE}
                        ############
                        # Facebook #
                        ############
## Load data on Facebook Page posts from database;
## also do a little data wrangling
connxn <- dbConnect(SQLite(), "data/nesreanigeria.db")

fbPosts <- dbGetQuery(connxn, 'SELECT * FROM nesreanigeria_fbposts') %>%
  prepare_data(.) %>%
  select(message:shares_count) %>%
  mutate(created_mth = format(as.Date(created_time), "%B")) %>%
  mutate(created_yr = format(as.Date(created_time), "%Y"))

dbDisconnect(connxn)
rm(connxn)

## make data frames for monthly
fbPosts$created_mth <-
  fbPosts$created_mth %>%
  factor(levels = month.name, ordered = TRUE)

fbPosts$created_time <- as.Date(fbPosts$created_time)

thisMth <- format(today(), "%B")
thisYr <- format(today(), "%Y")
mth_Posts <- filter(fbPosts, created_mth == thisMth & created_yr == thisYr)
wk_Posts <- filter(mth_Posts, created_time >= (today() - 7))

## Function that will return a message that matches a
## a particular metric within the table below
return_text <- function(df, metric) {
  column <- select(df, match(metric, colnames(df))) %>%
    unlist(.)
  txt <- df$message[match(max(column), column)]
  txt
}
```

## 2.2 Facebook
|     Description            |    Result                                |
|----------------------------|------------------------------------------|
|NESREA Page Posts (All-time)|`r nrow(fbPosts)`                         |
|Posts in `r thisMth`        |`r nrow(mth_Posts)`                       |
|Posts in the past 7 days    |`r nrow(wk_Posts)`                        |
|Most Liked  (Overall)       |`r return_text(fbPosts, "likes_count")`   |
|Most Liked in `r thisMth`   |`r return_text(mth_Posts, "likes_count")` |
|Most Shared (Overall)       |`r return_text(fbPosts, "shares_count")`  |
|Most Shared in `r thisMth`  |`r return_text(mth_Posts, "shares_count")`|
|Most Commented  (Overall)   |`r return_text(fbPosts, "comments_count")`|
|                            |                                          |

# 3.0 Exploratory Analysis
## 3.1 Twitter
```{r, warning=FALSE, message=FALSE}
distr <- ggplot(wk_data, aes(created)) +
  geom_density(aes(fill = isRetweet), alpha = .5) +
  theme(legend.justification = c(1, 1), legend.position = c(1, 1)) +
  xlab("Date") +
  ggtitle(paste("Distribution of tweets for", format(min(wk_data$created), "%d %b"), "to", format(max(wk_data$created), "%d %b %Y")))

distr
```

```{r, eval=FALSE}  
dayOf <- filter(wk_data, mday(created) == 7)
distr_day <- ggplot(dayOf, aes(created)) +
  geom_density(aes(fill = isRetweet), alpha = .5) +
  theme(legend.justification = c(1, 1), legend.position = c(1, 1)) +
  xlab("Time") +
  ggtitle("Tweets on... ")

distr_day
```

```{r, message=FALSE}
spl <- split(wk_data, wk_data$isRetweet)
orig <- spl[['FALSE']]
RT <- mutate(spl[['TRUE']], sender = substr(text, 5, regexpr(':', text) - 1))

pol <- suppressWarnings(lapply(orig$text, function(txt) {
  gsub("(\\.|!|\\?)+\\s+|(\\++)", " ", txt) %>% 
    gsub(" http[^[:blank:]]+", "", .) %>% 
    polarity(.)
}))
orig$emotionalValence <- sapply(pol, function(x) x$all$polarity)

polWordTable <- sapply(pol, function(p) {
  words <- c(positiveWords = paste(p$all$pos.words[[1]], collapse = ' '),
            negativeWords = paste(p$all$neg.words[[1]], collapse = ' '))
  gsub('-', '', words) 
}) %>%
  apply(1, paste, collapse = ' ') %>%
  stripWhitespace() %>%
  strsplit(' ') %>%
  sapply(table, simplify = FALSE)

oldpar <- par()
par(mfrow = c(1, 2))
invisible(
  lapply(1:2, function(i) {
    suppressWarnings(dotchart(sort(polWordTable[[i]]), cex = .8))
    mtext(names(polWordTable)[i])
  }))

suppressWarnings(par(oldpar))
```

* __Most positive tweet__: `r orig$text[which.max(orig$emotionalValence)]`
* __Most negative tweet__: `r orig$text[which.min(orig$emotionalValence)]`  

```{r, warning=FALSE, message=FALSE}
make_corpus <- function(GText, stem = TRUE) {
  corp <- VCorpus(VectorSource(GText)) %>% 
    tm_map(removePunctuation) %>%
    tm_map(stripWhitespace) %>%
    tm_map(content_transformer(tolower)) %>%
    tm_map(removeWords, stopwords("english"))
  if(stem)
    corp <- tm_map(corp, stemDocument) 
  
  names(corp) <- names(GText)
  corp
}

polSplit <- split(orig, sign(orig$emotionalValence))

if (length(polSplit) != 3) {
  warning("Insufficient data to render the wordcloud\n")
  } else {
  polText <- sapply(polSplit, function(df) {
    paste(tolower(df$text), collapse = ' ') %>%
      gsub(' http|@)[^[:blank:]]+', '', .) %>%  
      gsub('[[:punct:]]', '', .)
    }) %>%
    structure(names = c('negative', 'neutral', 'positive'))
  
    polText['negative'] <- removeWords(polText['negative'],
                                   names(polWordTable$negativeWords))
    polText['positive'] <- removeWords(polText['positive'],
                                       names(polWordTable$positiveWords))
    
    corp <- make_corpus(polText)
    col3 <- RColorBrewer::brewer.pal(3, 'Paired')
    suppressWarnings(comparison.cloud(as.matrix(TermDocumentMatrix(corp)),
                                      max.words = 150,
                                      min.freq = 1,
                                      random.order = FALSE,
                                      rot.per = 0,
                                      colors = col3,
                                      vfont = c("sans serif", "plain")))
  }
```

## 3.2 Facebook
**UNDER CONSTRUCTION**

# 4.0 Observations  

# 5.0 Recommendations

```{r, echo=FALSE}
victor <- person("Victor", "Ordu", email =  "victor.ordu@nesrea.gov.ng", comment = "Chairman Web Monitoring Group")
remi <- person("Remi", "Agunbiade", email = "remi.agunbiade@nesrea.gov.ng", comment = "Member, Web Monitoring Group")
amaka <- person("Amaka", "Ejiofor", email = "amaka.ejiofor@nesrea.gov.ng", comment = "Member, Web Monitoring Group")
eze <- person("Ezechinyere", "Achilefu", email = "ezechinyere.achilefu@nesrea.gov.ng", comment = "Member, Web Monitoring Group")
```

Submitted by:

`r paste(victor$given, victor$family)`  
`r victor$comment`  

***  
Built with *R `r getRversion()`*.